<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Skanner QR – zapis w jednym pliku</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#ffffff" />

  <script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    #reader { width: 100%; max-width: 420px; margin: 10px auto; }
    button { margin: 5px 3px; padding: 8px 12px; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #codes-list { margin-top: 15px; padding-left: 20px; }
    #codes-list li { word-break: break-all; margin-bottom: 3px; font-size: 14px; }
    #status { margin-top: 8px; font-size: 14px; }
    #reset-btn { background-color: #ff4d4d; color: #fff; }
    #torch-btn { background-color: #222; color: #fff; }
    #info-btn { background-color: #0b5; color: #fff; }
    .small { font-size: 12px; opacity: .8; margin-top: 6px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; }
  </style>
</head>

<body>
  <h2>Skanner QR – zapis w jednym pliku</h2>

  <div>
    <button id="start-btn">Start skanowania</button>
    <button id="stop-btn" disabled>Stop skanowania</button>
    <button id="torch-btn" disabled>Latarka: OFF</button>
    <button id="info-btn" disabled>Pokaż parametry video</button>
    <button id="clear-btn">Wyczyść listę</button>
    <button id="reset-btn">Reset skanera</button>
  </div>

  <div id="status">Status: nie skanuje</div>
  <div class="small">
    Tip: jeśli obraz jest “mydło”, nie rozciągaj podglądu na cały ekran. W tym kodzie max-width jest ograniczony,
    a kamera dostaje prośbę o wyższą rozdzielczość (1280×720).
  </div>

  <div id="reader"></div>
  <div id="video-info" class="mono"></div>

  <h3>Zeskanowane kody:</h3>
  <ul id="codes-list"></ul>

  <div>
    <button id="download-txt-btn">Pobierz TXT</button>
    <button id="download-csv-btn">Pobierz CSV (Excel)</button>
  </div>

  <script>
    const STORAGE_KEY = "qr_scanned_codes_v3";

    const scannedCodes = new Set();
    const codesListElement = document.getElementById("codes-list");
    const startBtn = document.getElementById("start-btn");
    const stopBtn = document.getElementById("stop-btn");
    const clearBtn = document.getElementById("clear-btn");
    const resetBtn = document.getElementById("reset-btn");
    const downloadTxtBtn = document.getElementById("download-txt-btn");
    const downloadCsvBtn = document.getElementById("download-csv-btn");
    const statusElement = document.getElementById("status");
    const torchBtn = document.getElementById("torch-btn");
    const infoBtn = document.getElementById("info-btn");
    const videoInfoEl = document.getElementById("video-info");

    const html5QrCode = new Html5Qrcode("reader");
    let scanning = false;
    let torchOn = false;

    function updateStatus(text) { statusElement.textContent = "Status: " + text; }

    function setButtonsState(isScanning) {
      scanning = isScanning;
      startBtn.disabled = isScanning;
      stopBtn.disabled = !isScanning;
      torchBtn.disabled = !isScanning;
      infoBtn.disabled = !isScanning;
    }

    function renderCodesList() {
      codesListElement.innerHTML = "";
      Array.from(scannedCodes).forEach(code => {
        const li = document.createElement("li");
        li.textContent = code;
        codesListElement.appendChild(li);
      });
    }

    function saveToLocalStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(scannedCodes)));
    }

    function loadFromLocalStorage() {
      const json = localStorage.getItem(STORAGE_KEY);
      if (!json) return;
      const arr = JSON.parse(json);
      if (Array.isArray(arr)) arr.forEach(code => scannedCodes.add(code));
    }

    function downloadFile(content, fileName, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadTxt() {
      if (scannedCodes.size === 0) return alert("Brak kodów.");
      downloadFile(Array.from(scannedCodes).join("\n"), "kody_qr.txt", "text/plain;charset=utf-8");
    }

    function downloadCsv() {
      if (scannedCodes.size === 0) return alert("Brak kodów.");
      const rows = ["Nr;Kod"];
      Array.from(scannedCodes).forEach((code, i) => {
        const safe = '"' + String(code).replace(/"/g, '""') + '"';
        rows.push(`${i + 1};${safe}`);
      });
      downloadFile(rows.join("\n"), "kody_qr.csv", "text/csv;charset=utf-8");
    }

    function clearCodes() {
      if (scannedCodes.size === 0) return;
      if (!confirm("Usunąć wszystkie kody z listy i zapisu w telefonie?")) return;
      scannedCodes.clear();
      saveToLocalStorage();
      renderCodesList();
      updateStatus("lista wyczyszczona");
    }

    async function getBackCameraId() {
      const devices = await Html5Qrcode.getCameras();
      if (!devices || devices.length === 0) return null;

      // heurystyka: szukamy "back", "rear", "environment" w label (na HTTPS label zwykle jest dostępny po zgodzie)
      const preferred = devices.find(d => /back|rear|environment/i.test(d.label || ""));
      return (preferred || devices[devices.length - 1]).id; // często ostatnia to tylna
    }

    async function applyQualityHints() {
      try {
        await html5QrCode.applyVideoConstraints({
          width: { ideal: 1920 },
          height: { ideal: 1080 },
          advanced: [
            { focusMode: "continuous" }
          ]
        });
      } catch (e) {
        // normalne – nie każde urządzenie/przeglądarka pozwala na wszystko
        console.warn("applyVideoConstraints nie w pełni wspierane:", e);
      }
    }

    async function setTorch(on) {
      try {
        await html5QrCode.applyVideoConstraints({ advanced: [{ torch: !!on }] });
        torchOn = !!on;
        torchBtn.textContent = `Latarka: ${torchOn ? "ON" : "OFF"}`;
      } catch (e) {
        console.warn("Torch nieobsługiwany:", e);
        torchBtn.disabled = true;
        alert("Latarka nie jest wspierana na tym telefonie/przeglądarce.");
      }
    }

    function showVideoInfo() {
      const video = document.querySelector("#reader video");
      if (!video) return;

      const track = video.srcObject?.getVideoTracks?.()[0];
      const settings = track?.getSettings?.() || {};
      const caps = track?.getCapabilities?.() || {};

      videoInfoEl.textContent =
        "VIDEO SETTINGS:\n" + JSON.stringify(settings, null, 2) +
        "\n\nVIDEO CAPABILITIES (fragment):\n" +
        JSON.stringify({
          width: caps.width,
          height: caps.height,
          focusMode: caps.focusMode,
          torch: caps.torch
        }, null, 2);
    }

    async function startScanning() {
      if (scanning) return;

      try {
        const backId = await getBackCameraId();
        if (!backId) return alert("Nie znaleziono kamery.");

        // Klucz do jakości na Chrome:
        // deviceId + prośba o wysoką rozdzielczość.
        const cameraConfig = {
          deviceId: { exact: backId },
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        };

        const config = {
          fps: 15,
          qrbox: { width: 320, height: 320 },
          disableFlip: true
        };

        await html5QrCode.start(
          cameraConfig,
          config,
          (msg) => {
            if (!scannedCodes.has(msg)) {
              scannedCodes.add(msg);
              saveToLocalStorage();
              renderCodesList();
            }
          },
          () => {}
        );

        setButtonsState(true);
        updateStatus("skanowanie trwa...");
        await applyQualityHints();

        // pokaż info automatycznie po 1s (żeby video zdążyło wystartować)
        setTimeout(showVideoInfo, 1000);

      } catch (err) {
        console.error(err);
        setButtonsState(false);
        updateStatus("błąd skanowania");
        alert("Nie udało się uruchomić kamery. Upewnij się, że strona jest na HTTPS i ma pozwolenie na kamerę.");
      }
    }

    async function stopScanning() {
      if (!scanning) return;
      try {
        if (torchOn) { try { await setTorch(false); } catch (_) {} }
        await html5QrCode.stop();
      } catch (err) {
        console.error(err);
      } finally {
        torchOn = false;
        torchBtn.textContent = "Latarka: OFF";
        videoInfoEl.textContent = "";
        setButtonsState(false);
        updateStatus("zatrzymano");
      }
    }

    async function resetScanner() {
      if (!confirm("Zresetować skaner i usunąć wszystkie zapisane kody?")) return;
      if (scanning) await stopScanning();
      scannedCodes.clear();
      localStorage.removeItem(STORAGE_KEY);
      renderCodesList();
      updateStatus("zresetowano");
      alert("Zresetowano – wszystkie kody usunięte.");
    }

    startBtn.addEventListener("click", startScanning);
    stopBtn.addEventListener("click", stopScanning);
    clearBtn.addEventListener("click", clearCodes);
    resetBtn.addEventListener("click", resetScanner);
    downloadTxtBtn.addEventListener("click", downloadTxt);
    downloadCsvBtn.addEventListener("click", downloadCsv);

    torchBtn.addEventListener("click", async () => {
      if (!scanning) return;
      await setTorch(!torchOn);
    });

    infoBtn.addEventListener("click", showVideoInfo);

    window.addEventListener("beforeunload", () => { stopScanning(); });

    loadFromLocalStorage();
    renderCodesList();
    updateStatus("nie skanuje (kody wczytane z pamięci)");

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js")
        .then(reg => console.log("SW OK:", reg.scope))
        .catch(err => console.error("SW error:", err));
    }
  </script>
</body>
</html>
