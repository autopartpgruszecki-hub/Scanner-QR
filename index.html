<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Skanner QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    #reader { width: 100%; max-width: 420px; margin: 10px auto; }
    button { margin: 5px 3px; padding: 8px 12px; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #codes-list { margin-top: 15px; padding-left: 20px; }
    #codes-list li { word-break: break-all; margin-bottom: 3px; font-size: 14px; }
    #status { margin-top: 8px; font-size: 14px; }
    #reset-btn { background-color: #ff4d4d; color: #fff; }
    #torch-btn { background-color: #222; color: #fff; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; }
  </style>
</head>

<body>
  <h2>Skanner QR</h2>

  <div>
    <button id="start-btn">Start</button>
    <button id="stop-btn" disabled>Stop</button>
    <button id="torch-btn" disabled>Latarka: OFF</button>
    <button id="clear-btn">Wyczyść</button>
    <button id="reset-btn">Reset</button>
  </div>

  <div id="status">Status: nie skanuje</div>
  <div id="debug" class="mono"></div>

  <div id="reader"></div>

  <h3>Zeskanowane kody:</h3>
  <ul id="codes-list"></ul>

  <div>
    <button id="download-txt-btn">Pobierz TXT</button>
    <button id="download-csv-btn">Pobierz CSV</button>
  </div>

  <script>
    const STORAGE_KEY = "qr_scanned_codes_v4";
    const scannedCodes = new Set();

    const elList = document.getElementById("codes-list");
    const startBtn = document.getElementById("start-btn");
    const stopBtn = document.getElementById("stop-btn");
    const clearBtn = document.getElementById("clear-btn");
    const resetBtn = document.getElementById("reset-btn");
    const txtBtn = document.getElementById("download-txt-btn");
    const csvBtn = document.getElementById("download-csv-btn");
    const statusEl = document.getElementById("status");
    const torchBtn = document.getElementById("torch-btn");
    const debugEl = document.getElementById("debug");

    let scanning = false;
    let torchOn = false;

    function setStatus(t) { statusEl.textContent = "Status: " + t; }
    function setDebug(t) { debugEl.textContent = t || ""; }

    function setButtons(isScanning) {
      scanning = isScanning;
      startBtn.disabled = isScanning;
      stopBtn.disabled = !isScanning;
      torchBtn.disabled = !isScanning;
    }

    function renderList() {
      elList.innerHTML = "";
      for (const code of scannedCodes) {
        const li = document.createElement("li");
        li.textContent = code;
        elList.appendChild(li);
      }
    }

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...scannedCodes]));
    }

    function load() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) arr.forEach(x => scannedCodes.add(x));
      } catch {}
    }

    function downloadFile(content, name, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadTxt() {
      if (!scannedCodes.size) return alert("Brak kodów.");
      downloadFile([...scannedCodes].join("\n"), "kody_qr.txt", "text/plain;charset=utf-8");
    }

    function downloadCsv() {
      if (!scannedCodes.size) return alert("Brak kodów.");
      const rows = ["Nr;Kod"];
      [...scannedCodes].forEach((code, i) => {
        const safe = '"' + String(code).replace(/"/g, '""') + '"';
        rows.push(`${i+1};${safe}`);
      });
      downloadFile(rows.join("\n"), "kody_qr.csv", "text/csv;charset=utf-8");
    }

    function clearAll() {
      if (!scannedCodes.size) return;
      if (!confirm("Usunąć wszystkie kody?")) return;
      scannedCodes.clear();
      save();
      renderList();
      setStatus("wyczyszczono");
    }

    async function applyQualityHints(html5QrCode) {
      // Nie każde urządzenie wspiera wszystko — dlatego bez paniki jak się nie uda.
      try {
        await html5QrCode.applyVideoConstraints({
          width: { ideal: 1920 },
          height: { ideal: 1080 },
          advanced: [{ focusMode: "continuous" }]
        });
      } catch (e) {
        // OK
      }
    }

    function showVideoSettings() {
      const video = document.querySelector("#reader video");
      const track = video?.srcObject?.getVideoTracks?.()?.[0];
      const s = track?.getSettings?.() || {};
      setDebug("VIDEO SETTINGS:\n" + JSON.stringify(s, null, 2));
    }

    async function setTorch(html5QrCode, on) {
      try {
        await html5QrCode.applyVideoConstraints({ advanced: [{ torch: !!on }] });
        torchOn = !!on;
        torchBtn.textContent = `Latarka: ${torchOn ? "ON" : "OFF"}`;
      } catch (e) {
        torchBtn.disabled = true;
        alert("Latarka nieobsługiwana na tym urządzeniu.");
      }
    }

    // --- najważniejsze: odporne startowanie kamery ---
    async function startScanning() {
      if (scanning) return;

      if (typeof Html5Qrcode === "undefined") {
        alert("Nie wczytała się biblioteka html5-qrcode (sprawdź internet / SW / blokady).");
        return;
      }

      const html5QrCode = new Html5Qrcode("reader");

      const config = {
        fps: 15,
        qrbox: { width: 320, height: 320 },
        disableFlip: true
      };

      const onScanSuccess = (msg) => {
        if (!scannedCodes.has(msg)) {
          scannedCodes.add(msg);
          save();
          renderList();
        }
      };

      // 1) Najpierw: facingMode (najbardziej kompatybilne)
      try {
        await html5QrCode.start(
          {
            facingMode: { ideal: "environment" },
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          config,
          onScanSuccess,
          () => {}
        );

        setButtons(true);
        setStatus("skanuje");
        setTimeout(showVideoSettings, 800);
        await applyQualityHints(html5QrCode);

        // podpinamy torch na aktualnym obiekcie
        torchBtn.onclick = () => setTorch(html5QrCode, !torchOn);

        // zapamiętujemy do stop()
        window.__qr = html5QrCode;
        return;
      } catch (e1) {
        console.warn("Start facingMode nie wyszedł:", e1);
      }

      // 2) Fallback: spróbuj deviceId, ale bez "exact" (mniej wywrotek)
      try {
        const cams = await Html5Qrcode.getCameras();
        if (!cams?.length) throw new Error("Brak kamer");

        const camId = cams[cams.length - 1].id; // często tylna jest na końcu

        await html5QrCode.start(
          { deviceId: camId, width: { ideal: 1920 }, height: { ideal: 1080 } },
          config,
          onScanSuccess,
          () => {}
        );

        setButtons(true);
        setStatus("skanuje (deviceId fallback)");
        setTimeout(showVideoSettings, 800);
        await applyQualityHints(html5QrCode);

        torchBtn.onclick = () => setTorch(html5QrCode, !torchOn);
        window.__qr = html5QrCode;
        return;
      } catch (e2) {
        console.error("Start fallback nie wyszedł:", e2);
        setButtons(false);
        setStatus("błąd");
        alert("Nie udało się uruchomić kamery. Sprawdź: HTTPS + pozwolenie na kamerę + czy inna apka nie używa kamery.");
      }
    }

    async function stopScanning() {
      if (!scanning) return;
      const html5QrCode = window.__qr;
      try {
        if (torchOn) { try { await setTorch(html5QrCode, false); } catch {} }
        await html5QrCode.stop();
      } catch (e) {
        console.warn(e);
      } finally {
        torchOn = false;
        torchBtn.textContent = "Latarka: OFF";
        setDebug("");
        setButtons(false);
        setStatus("zatrzymano");
      }
    }

    async function resetScanner() {
      if (!confirm("Zresetować i usunąć wszystkie kody?")) return;
      if (scanning) await stopScanning();
      scannedCodes.clear();
      localStorage.removeItem(STORAGE_KEY);
      renderList();
      setStatus("zresetowano");
    }

    startBtn.addEventListener("click", startScanning);
    stopBtn.addEventListener("click", stopScanning);
    clearBtn.addEventListener("click", clearAll);
    resetBtn.addEventListener("click", resetScanner);
    txtBtn.addEventListener("click", downloadTxt);
    csvBtn.addEventListener("click", downloadCsv);

    window.addEventListener("beforeunload", () => { stopScanning(); });

    load();
    renderList();
    setStatus("nie skanuje (wczytano z pamięci)");
  </script>
</body>
</html>
